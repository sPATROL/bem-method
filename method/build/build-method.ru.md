# Методология сборки БЭМ-проекта

Методология БЭМ предполагает разделение интерфейса на независимые [блоки](../definitions/definitions.ru.md#Блок). Блоки, в свою очередь, могут быть реализованы в одной или нескольких [технологиях](../definitions/definitions.ru.md#Технология-реализации). Технологии реализации находятся в отдельных файлах. [Реализация](../definitions/definitions.ru.md#Реализация-блока) каждого блока может быть дополнительно разделена по [уровням переопределения](../definitions/definitions.ru.md#Уровень-переопределения).

```
blocks/                 # Уровень проекта
    input/              # Директория блока `input`
        input.css       # Реализация блока `input` в технологии CSS
        input.js        # Реализация блока `input` в технологии JavaScript
    icon/
        icon.css
library/                # Уровень библиотеки
    input/
    button/
```

Подобная организация файловой системы, обусловленная использованием компонентного подхода, определяет порядок сборки БЭМ-проекта.

>Подробно о причинах разделения блоков на отдельные файлы читайте в документе [Организация файловой системы БЭМ-проекта](../filesystem/filesystem.ru.md).

**На этой странице вы найдете:**

<!-- TOC -->
* <a href="#особенности-сборки-бэм-проекта">Особенности сборки БЭМ-проекта</a>
  * <a href="#декларация">Декларация</a>
    * <a href="#способы-получения-декларации">Способы получения декларации</a>
    * <a href="#способы-манипуляции-декларациями">Способы манипуляции декларациями</a>
  * <a href="#зависимости">Зависимости</a>
  * <a href="#уровни-переопределения">Уровни переопределения</a>
* <a href="#управляемая-сборка-vs-неуправляемая">Управляемая сборка vs. неуправляемая</a>
* <a href="#инструменты-для-сборки">Инструменты для сборки</a>

<!-- TOC END -->

<!-- TOC ELEMENT -->
<a name="особенности-сборки-бэм-проекта"></a>
## Особенности сборки БЭМ-проекта

Основная задача сборки — из множества [файлов реализаций](../filesystem/filesystem.ru.md#Реализация-блока-разделяется-на-отдельные-файлы) собрать в проект только нужные. При этом важно учитывать порядок подключения файлов в сборку.

<a name="bundle"></a>
Результатом сборки является бандл. **Бандл** — это совокупность необходимых реализаций [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), подключенных в определенном порядке.

Бандлом может быть страница сайта, любой ее фрагмент или сразу несколько страниц. Например, если у всех страниц сайта одинаковая шапка и подвал, можно выделить их реализацию в отдельный бандл, собрать один раз и подключать при сборке.

>В документе рассмотрена сборка бандла на примере страницы.

При сборке используются следующие понятия:

* [Декларация](#Декларация)
* [Зависимости](#Зависимости)
* [Уровни переопределения](#Уровни-переопределения)

<!-- TOC ELEMENT -->
<a name="декларация"></a>
### Декларация

Это упорядоченный список [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), необходимых для сборки [бандла](#bundle). Декларация определяет, что и в каком порядке подключать в сборку. Благодаря декларации в сборку попадают только нужные БЭМ-сущности.

![Декларация](https://img-fotki.yandex.ru/get/4524/246231603.1/0_162b0b_2b0f783_orig)

Рассмотрим на примере:

В проекте на отдельный уровень переопределения подключена библиотека, из которой на странице используются только несколько блоков. Нет необходимости включать все блоки библиотеки в сборку страницы. Достаточно указать в декларации нужный набор блоков и подключать в сборку только их.

Таким образом, декларация позволяет отфильтровать только необходимые для сборки бандла файлы реализаций с подключенных в сборку уровней переопределения.

Декларация может формироваться вручную или строиться автоматически. Подробно читайте в разделе [Способы получения декарации](#Способы-получения-декларации).

Декларация может описывать сущности целой страницы, только ее части или сразу нескольких страниц. О причинах появления разных типов деклараций читайте в разделе [Способы манипуляции декларациями](#Способы-манипуляции-декларациями).

Пример расположения файла с декларацией в файловой системе:

```
.build-tool/
    make.js
blocks/
    input/
        input.css
        input.js
    button/
        button.css
        button.js
    checkbox/
        checkbox.css
        checkbox.js
bundles/
    bundle/
        bundle.bemdecl.js # Упорядоченный список БЭМ-сущностей для сборки бандла
```

Формат декларации представляет собой плоский список сущностей.

>В БЭМ-платформе список БЭМ-сущностей принято описывать в формате BEMDECL, например:
```
exports.blocks = [
    { name: 'input' },
    { name: 'button' },
    { name: 'checkbox' }
];
```

<!-- TOC ELEMENT -->
<a name="способы-получения-декларации"></a>
#### Способы получения декларации

Существуют разные способы создания декларации бандла. Рассмотрим основные из них:

* [Автоматическая генерация по описанию страницы](#Создание-декларации-по-описанию-страницы)
* [Автоматическая генерация с помощью интроспекции файловой системы](#Создание-декларации-с-помощью-интроспекции-файловой-системы)
* [Создание декларации вручную](#Создание-декларации-вручную)

##### Создание декларации по описанию страницы

В методологии существует понятие [БЭМ-дерева](../definitions/definitions.ru.md#БЭМ-дерево) — описания структуры страницы в терминах блоков, элементов и модификаторов. БЭМ-дерево содержит имена [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), которые используются на странице. При сборке проекта декларация строится автоматически на основании данных из БЭМ-дерева.

![Способ создания декларации](https://img-fotki.yandex.ru/get/6114/246231603.1/0_162b0c_f5211dc6_orig)

Пример показывает, как в результате анализа HTML-классов, написанных в соответствии с [соглашением по именованию БЭМ](../naming/naming.ru.md), создается декларация.

Один из инструментов, позволяющих получить декларацию из HTML-структуры страницы — [html2bemjson](https://github.com/tadatuta/html2bemjson).

>Пример проекта с созданием декларации для каждой страницы на основе ее описания — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).

##### Создание декларации с помощью интроспекции файловой системы

При сборке в декларацию автоматически попадают все БЭМ-сущности, находящиеся в файловой системе проекта.

![Способ создания декларации](https://img-fotki.yandex.ru/get/4510/246231603.1/0_162b0d_d4139277_orig)

>В [bem-components](https://ru.bem.info/libs/bem-components/) такой способ создания декларации используется для поставки библиотеки в виде [Dist](https://ru.bem.info/libs/bem-components/current/#Варианты-поставки-библиотеки).

##### Создание декларации вручную

Декларация может быть создана разработчиком вручную. Для этого нужно перечислить БЭМ-сущности, необходимые для построения страницы.

![Способ создания декларации](https://img-fotki.yandex.ru/get/9322/246231603.1/0_162b0e_28dd6cc2_orig)

<!-- TOC ELEMENT -->
<a name="способы-манипуляции-декларациями"></a>
#### Способы манипуляции декларациями

Бандлы можно рассматривать как компоненты проекта, их можно по-разному совмещать, повторно использовать, выделять общие части или различия.
Бандлы собираются на основе деклараций, поэтому управление бандлами происходит с помощью деклараций.

Рассмотрим возможные действия с файлами деклараций:

* [сложение](#Объединение-нескольких-деклараций-в-одну) — объединение нескольких деклараций в одну;
* [вычитание](#Получение-разницы-между-декларациями) — получение разницы между декларациями;
* [пересечение](#Получение-новой-декларации-на-основе-пересечения-нескольких-других) — получение новой декларации на основе пересечения нескольких других.

##### Объединение нескольких деклараций в одну

Применяется для объединенной сборки нескольких деклараций страниц. В результате для этих страниц генерируются общие файлы технологий (например, один CSS- и JavaScript-файл), которые загружаются при первом запросе. Такой подход сокращает количество обращений к серверу.

##### Получение разницы между декларациями

Может применятся для получения бандла, который догружается на страницу по требованию.

Напрмер, на странице используется виртуальная клавиатура, которая становится доступна пользователю только в ответ на определенное действие. Нет необходимости включать этот блок в сборку всей страницы, так как это увеличит время при загрузке. Частично кнопки клавиатуры могут быть уже реализованы на странице для других целей. Возможность вычитать декларации позволяет создать отдельный бандл для недостающей реализации виртуальной клавиатуры и подключать его только по требованию.

##### Получение новой декларации на основе пересечения нескольких других

Применяется для сборки бандлов на основе декларации, содержащей общую часть для разных страниц.

Например, такое разделение эффективно, если в проекте на разных страницах используются одинаковые компоненты (например, шапка и подвал). Общая часть страниц описывается в отдельной декларации. При сборке страница создается из двух деклараций: общей и уникальной.

<!-- TOC ELEMENT -->
<a name="зависимости"></a>
### Зависимости

Реализация БЭМ-сущностей разделена на отдельные файлы технологий. Для правильной работы блоков, элементов и модификаторов может потребоваться указать их зависимости от других БЭМ-сущностей проекта.

Существует несколько способов прописать зависимости:

* В файлах реализации блока.<br>
```
blocks/
    input/
        input.css
        input.js        # Файл `js`, который декларирует зависимости с помощью модульной системы
    button/
        button.css
        button.js
    icon/
        icon.css
```

* В отдельном файле блока.<br>
```
blocks/
    input/
        input.css
        input.js
        input.deps.js   # Файл с зависимостями блока `input`
    button/
        button.css
        button.js
    icon/
        icon.css
```

На основе знаний о зависимостях сборщик определяет, какие дополнительные сущности или технологии необходимы для реализации блока, и включает их при сборке в требуемом порядке в бандл.

>В БЭМ-платформе для указания зависимостей используется технология [DEPS](https://ru.bem.info/technology/deps/).

<!-- TOC ELEMENT -->
<a name="уровни-переопределения"></a>
### Уровни переопределения

>О том, [что такое уровни переопределения](../definitions/definitions.ry.md#Уровень-переопределения) и [для чего они используются](../filesystem/filesystem.ru.md#Проект-разделяется-на-уровни-переопределения), читайте в документе об [организации файловой системы БЭМ-проекта](../filesystem/filesystem.ru.md).

Уровни переопределения позволяют изменить реализацию БЭМ-сущностей. Для этого важно соблюдать порядок подключения уровней при сборке проекта.

Схема показывает принцип использования уровней переопределения при сборке:

![Уровни переопределения](https://img-fotki.yandex.ru/get/15587/246231603.1/0_162b0f_98525a17_orig)

Подробно об использовании уровней читайте в примерах:

* [Переопределение блоков библиотеки](https://github.com/bem/bem-method/blob/bem-file-system/method/filesystem/filesystem1.ru.md#Подключение-библиотеки).
* [Разделение проекта на платформы](https://github.com/bem/bem-method/blob/bem-file-system/method/filesystem/filesystem1.ru.md#Разделение-проекта-на-платформы).

<!-- TOC ELEMENT -->
<a name="управляемая-сборка-vs-неуправляемая"></a>
## Управляемая сборка vs. неуправляемая

Зависимости, уровни переопределения и наличие декларации позволяет применять гибкую управляемую сборку:

* подключать в проект только нужные БЭМ-сущности и технологии;
* переопределять БЭМ-сущности без дублирования кода;
* выделять повторно используемые части проекта в отдельные бандлы.

Однако, использование зависимостей, уровней переопределения и декларации опционально. В проект могут быть собраны все БЭМ-сущности с файловой системы. В таком случае описание страницы должно содержать абсолютно все необходимые блоки, элементы и модификаторы, которые используются для построения страницы.

<!-- TOC ELEMENT -->
<a name="инструменты-для-сборки"></a>
## Инструменты для сборки

Выбор инструмента для сборки зависит от сложности БЭМ-проекта, наличия в нем уровней переопределения и использования зависимостей.

БЭМ-методология не ограничивает выбор инструмента — можно использовать любые сборщики (например, Gulp, Grant, Brunch, Broccoli), отвечающие требованиям вашего проекта.

>Пример сборки БЭМ-проекта с помощью Gulp — [Декларативный JavaScript по БЭМ](https://ru.bem.info/events/beminar-july-2015/).

В БЭМ-платформе реализованы два инструмента, которые подходят для сборки БЭМ-проектов любой сложности:

* [ENB](https://ru.bem.info/tools/bem/enb-bem/)
* [bem-tools](https://ru.bem.info/tools/bem/bem-tools/)

>Пример сборки БЭМ-проекта с помощью [ENB](https://ru.bem.info/tools/bem/enb-bem/) или [bem-tools](https://ru.bem.info/tools/bem/bem-tools/) — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).
